<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>내 캘린더</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles for the calendar */
        body {
            font-family: 'Inter', sans-serif;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px; /* Creates the grid lines */
        }
        .calendar-day {
            min-height: 120px; /* Ensures each day cell has enough height */
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="flex h-screen flex-col">
        <!-- Header Section -->
        <header class="bg-white shadow-sm z-10">
            <div class="container mx-auto px-4 py-3 flex items-center justify-between">
                <!-- Left side: Title and Month Navigation -->
                <div class="flex items-center space-x-4">
                    <i class="fas fa-calendar-alt text-blue-500 text-2xl"></i>
                    <h1 class="text-xl font-bold text-gray-700">My Calendar</h1>
                    <div class="flex items-center ml-6">
                        <button id="prev-month-btn" class="p-2 rounded-full hover:bg-gray-200 transition-colors">
                            <i class="fas fa-chevron-left text-gray-600"></i>
                        </button>
                        <h2 id="current-month-year-text" class="text-lg font-semibold w-32 text-center"></h2>
                        <button id="next-month-btn" class="p-2 rounded-full hover:bg-gray-200 transition-colors">
                            <i class="fas fa-chevron-right text-gray-600"></i>
                        </button>
                    </div>
                </div>
                <!-- Right side: Auth container -->
                <div id="auth-container">
                    <button id="google-login-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg flex items-center space-x-2 transition-colors">
                        <i class="fab fa-google"></i>
                        <span>Google 계정으로 로그인</span>
                    </button>
                    <div id="user-profile" class="hidden items-center space-x-3">
                        <img id="user-photo" class="w-8 h-8 rounded-full" alt="User photo">
                        <span id="user-name" class="font-semibold text-sm"></span>
                        <button id="logout-btn" class="text-sm text-gray-600 hover:text-blue-500">로그아웃</button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Calendar Section -->
        <main class="flex-grow container mx-auto p-4">
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <!-- Day of the week headers -->
                <div class="grid grid-cols-7 text-center font-semibold text-sm text-gray-600 border-b">
                    <div class="py-2">일</div>
                    <div class="py-2">월</div>
                    <div class="py-2">화</div>
                    <div class="py-2">수</div>
                    <div class="py-2">목</div>
                    <div class="py-2">금</div>
                    <div class="py-2">토</div>
                </div>
                <!-- Calendar grid where days will be populated -->
                <div id="calendar-grid-container" class="calendar-grid bg-gray-200">
                    <!-- JavaScript will generate day cells here -->
                </div>
            </div>
        </main>
    </div>

    <!-- Event Details Modal (Popup) -->
    <div id="event-modal-container" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6 m-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">일정 상세</h3>
                <button id="close-modal-btn" class="text-gray-500 hover:text-gray-800 text-2xl leading-none">&times;</button>
            </div>
            <div>
                <h4 id="modal-title-text" class="text-lg font-semibold mb-2"></h4>
                <p id="modal-time-text" class="text-sm text-gray-600 mb-4"></p>
                <p id="modal-description-text" class="text-gray-700"></p>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        // --- 중요 ---
        // Firebase 프로젝트 설정 정보입니다.
        const firebaseConfig = {
            apiKey: "AIzaSyAVmt80PhJ1YCkKfgyK4aKabIfr8uokAO8",
            authDomain: "calender-64034.firebaseapp.com",
            projectId: "calender-64043",
            storageBucket: "calender-64034.appspot.com",
            messagingSenderId: "895431766904",
            appId: "1:895431766904:web:5ebe5c63c83e685baece8d",
            measurementId: "G-9GEV4QVRV5"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();
        
        // Google Calendar API 접근 권한을 요청합니다.
        provider.addScope('https://www.googleapis.com/auth/calendar.readonly');

        // --- Auth UI Elements ---
        const loginBtn = document.getElementById('google-login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const userProfileDiv = document.getElementById('user-profile');
        const userNameSpan = document.getElementById('user-name');
        const userPhotoImg = document.getElementById('user-photo');

        // --- Auth Event Listeners ---
        loginBtn.addEventListener('click', () => {
            signInWithPopup(auth, provider)
                .then((result) => {
                    const credential = GoogleAuthProvider.credentialFromResult(result);
                    const accessToken = credential.accessToken;
                    // 로그인 성공 시 백엔드 서버에 캘린더 데이터를 요청합니다.
                    fetchGoogleCalendarEvents(accessToken);
                })
                .catch((error) => console.error("Login Error:", error));
        });

        logoutBtn.addEventListener('click', () => {
            signOut(auth)
                .catch((error) => console.error("Logout Error:", error));
        });

        // --- Auth State Change Handler ---
        onAuthStateChanged(auth, (user) => {
            if (user) { // User is signed in
                loginBtn.classList.add('hidden');
                userProfileDiv.classList.remove('hidden');
                userProfileDiv.classList.add('flex');
                userNameSpan.textContent = user.displayName;
                userPhotoImg.src = user.photoURL;
            } else { // User is signed out
                loginBtn.classList.remove('hidden');
                userProfileDiv.classList.add('hidden');
                userProfileDiv.classList.remove('flex');
                // 로그아웃 시 캘린더 이벤트를 모두 지웁니다.
                renderCalendar({});
            }
        });

        // --- Calendar Logic (Starts here) ---
        let calendarEvents = {};

        // ** Node.js 백엔드 서버에 캘린더 이벤트를 요청하는 함수 **
        const fetchGoogleCalendarEvents = (token) => {
            
            // --- 여기가 가장 중요합니다! ---
            // 보내주신 Render 서버 주소로 업데이트했습니다.
            const backendUrl = 'https://calendar-backend-owbu.onrender.com/get-calendar-events';

            fetch(backendUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ accessToken: token }),
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('서버에서 응답을 받지 못했습니다.');
                }
                return response.json();
            })
            .then(data => {
                calendarEvents = data;
                renderCalendar(calendarEvents); // 서버로부터 받은 실제 데이터로 캘린더를 그립니다.
            })
            .catch(error => {
                console.error('캘린더 이벤트 로딩 실패:', error);
                alert('캘린더 이벤트를 가져오는 데 실패했습니다. 백엔드 서버가 켜져 있는지 확인해주세요.');
            });
        };

        // --- 아래는 캘린더를 화면에 그리는 로직입니다. (수정 불필요) ---
        document.addEventListener('DOMContentLoaded', () => {
            const calendarGrid = document.getElementById('calendar-grid-container');
            const currentMonthYearText = document.getElementById('current-month-year-text');
            const prevMonthBtn = document.getElementById('prev-month-btn');
            const nextMonthBtn = document.getElementById('next-month-btn');
            const eventModal = document.getElementById('event-modal-container');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const modalTitle = document.getElementById('modal-title-text');
            const modalTime = document.getElementById('modal-time-text');
            const modalDescription = document.getElementById('modal-description-text');

            let currentDate = new Date();

            const renderCalendar = (events = {}) => {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                currentMonthYearText.textContent = `${year}년 ${month + 1}월`;
                calendarGrid.innerHTML = '';
                const firstDayOfMonth = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();

                for (let i = 0; i < firstDayOfMonth; i++) {
                    const emptyCell = document.createElement('div');
                    emptyCell.className = 'calendar-day bg-gray-50';
                    calendarGrid.appendChild(emptyCell);
                }

                for (let day = 1; day <= daysInMonth; day++) {
                    const dayCell = document.createElement('div');
                    dayCell.className = 'calendar-day bg-white p-2 flex flex-col relative hover:bg-gray-50 transition-colors';
                    const dayNumber = document.createElement('span');
                    dayNumber.textContent = day;
                    dayNumber.className = 'text-sm self-start';
                    const today = new Date();
                    if (year === today.getFullYear() && month === today.getMonth() && day === today.getDate()) {
                        dayNumber.className += ' bg-blue-500 text-white rounded-full w-6 h-6 flex items-center justify-center';
                    }
                    dayCell.appendChild(dayNumber);
                    const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    
                    if (events[dateString]) {
                        events[dateString].forEach(eventData => {
                            const eventDiv = document.createElement('div');
                            eventDiv.className = 'bg-blue-100 text-blue-800 text-xs rounded px-1 py-0.5 mt-1 cursor-pointer truncate hover:bg-blue-200';
                            eventDiv.textContent = eventData.title;
                            eventDiv.addEventListener('click', (e) => {
                                e.stopPropagation();
                                openEventModal(eventData);
                            });
                            dayCell.appendChild(eventDiv);
                        });
                    }
                    calendarGrid.appendChild(dayCell);
                }
            };

            const openEventModal = (eventData) => {
                modalTitle.textContent = eventData.title;
                modalTime.textContent = eventData.time;
                modalDescription.textContent = eventData.description;
                eventModal.classList.remove('hidden');
                eventModal.classList.add('flex');
            };

            const closeEventModal = () => {
                eventModal.classList.add('hidden');
                eventModal.classList.remove('flex');
            };

            prevMonthBtn.addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() - 1);
                renderCalendar(calendarEvents);
            });

            nextMonthBtn.addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() + 1);
                renderCalendar(calendarEvents);
            });

            closeModalBtn.addEventListener('click', closeEventModal);
            eventModal.addEventListener('click', (e) => {
                if (e.target === eventModal) {
                    closeEventModal();
                }
            });
            
            renderCalendar();
        });
    </script>
</body>
</html>
