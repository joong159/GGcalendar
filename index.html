<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>내 캘린더</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; }
        .calendar-day { min-height: 120px; }
        .hidden { display: none; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="flex h-screen flex-col">
        <!-- Header Section -->
        <header class="bg-white shadow-sm z-10">
            <div class="container mx-auto px-4 py-3 flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <i class="fas fa-calendar-alt text-blue-500 text-2xl"></i>
                    <h1 class="text-xl font-bold text-gray-700">My Calendar</h1>
                    <div class="flex items-center ml-6">
                        <button id="prev-month-btn" class="p-2 rounded-full hover:bg-gray-200"><i class="fas fa-chevron-left text-gray-600"></i></button>
                        <h2 id="current-month-year-text" class="text-lg font-semibold w-32 text-center"></h2>
                        <button id="next-month-btn" class="p-2 rounded-full hover:bg-gray-200"><i class="fas fa-chevron-right text-gray-600"></i></button>
                    </div>
                    <button id="new-event-btn" class="ml-4 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg flex items-center space-x-2 hidden">
                        <i class="fas fa-plus"></i>
                        <span>새 일정</span>
                    </button>
                </div>
                <div id="auth-container">
                    <button id="google-login-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg flex items-center space-x-2">
                        <i class="fab fa-google"></i>
                        <span>Google 계정으로 로그인</span>
                    </button>
                    <div id="user-profile" class="hidden items-center space-x-3">
                        <img id="user-photo" class="w-8 h-8 rounded-full" alt="User photo">
                        <span id="user-name" class="font-semibold text-sm"></span>
                        <button id="logout-btn" class="text-sm text-gray-600 hover:text-blue-500">로그아웃</button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Calendar Section -->
        <main class="flex-grow container mx-auto p-4">
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <div class="grid grid-cols-7 text-center font-semibold text-sm text-gray-600 border-b">
                    <div class="py-2">일</div><div class="py-2">월</div><div class="py-2">화</div><div class="py-2">수</div><div class="py-2">목</div><div class="py-2">금</div><div class="py-2">토</div>
                </div>
                <div id="calendar-grid-container" class="calendar-grid bg-gray-200"></div>
            </div>
        </main>
    </div>

    <!-- Event Details Modal -->
    <div id="event-modal-container" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6 m-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">일정 상세</h3>
                <button id="close-modal-btn" class="text-gray-500 hover:text-gray-800 text-2xl leading-none">&times;</button>
            </div>
            <div>
                <h4 id="modal-title-text" class="text-lg font-semibold mb-2"></h4>
                <p id="modal-time-text" class="text-sm text-gray-600 mb-4"></p>
                <p id="modal-description-text" class="text-gray-700"></p>
            </div>
        </div>
    </div>

    <!-- New Event Modal -->
    <div id="new-event-modal-container" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6 m-4">
            <h3 class="text-xl font-bold mb-4">새 일정 만들기</h3>
            <form id="new-event-form">
                <div class="mb-4">
                    <label for="event-title" class="block text-sm font-medium text-gray-700">제목</label>
                    <input type="text" id="event-title" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="mb-4">
                    <label for="event-date" class="block text-sm font-medium text-gray-700">날짜</label>
                    <input type="date" id="event-date" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="mb-4">
                    <label for="event-description" class="block text-sm font-medium text-gray-700">설명</label>
                    <textarea id="event-description" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>
                <div class="mb-4">
                    <label class="flex items-center">
                        <input type="checkbox" id="event-private" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                        <span class="ml-2 text-sm text-gray-700">나만 보기 (비공개)</span>
                    </label>
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" id="cancel-new-event-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">취소</button>
                    <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">저장</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAVmt80PhJ1YCkKfgyK4aKabIfr8uokAO8",
            authDomain: "calender-64034.firebaseapp.com",
            projectId: "calender-64034",
            storageBucket: "calender-64034.appspot.com",
            messagingSenderId: "895431766904",
            appId: "1:895431766904:web:5ebe5c63c83e685baece8d",
            measurementId: "G-9GEV4QVRV5"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();
        provider.addScope('https://www.googleapis.com/auth/calendar');

        // --- UI 요소 ---
        const loginBtn = document.getElementById('google-login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const userProfileDiv = document.getElementById('user-profile');
        const userNameSpan = document.getElementById('user-name');
        const userPhotoImg = document.getElementById('user-photo');
        const newEventBtn = document.getElementById('new-event-btn');
        const newEventModal = document.getElementById('new-event-modal-container');
        const newEventForm = document.getElementById('new-event-form');
        const cancelNewEventBtn = document.getElementById('cancel-new-event-btn');
        const calendarGrid = document.getElementById('calendar-grid-container');
        const currentMonthYearText = document.getElementById('current-month-year-text');
        const eventModal = document.getElementById('event-modal-container');
        const modalTitle = document.getElementById('modal-title-text');
        const modalTime = document.getElementById('modal-time-text');
        const modalDescription = document.getElementById('modal-description-text');
        
        let currentAccessToken = null;
        let calendarEvents = {};
        let currentDate = new Date();

        // --- 함수 정의 ---
        
        // ** 수정된 부분: 아래 함수들의 실제 내용을 모두 채워넣었습니다. **
        const openEventModal = (eventData) => {
            modalTitle.textContent = eventData.title;
            modalTime.textContent = eventData.time;
            modalDescription.textContent = eventData.description;
            eventModal.classList.remove('hidden');
            eventModal.classList.add('flex');
        };
        
        const renderCalendar = (events = {}) => {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            currentMonthYearText.textContent = `${year}년 ${month + 1}월`;
            calendarGrid.innerHTML = '';
            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            for (let i = 0; i < firstDayOfMonth; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'calendar-day bg-gray-50';
                calendarGrid.appendChild(emptyCell);
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const dayCell = document.createElement('div');
                dayCell.className = 'calendar-day bg-white p-2 flex flex-col relative hover:bg-gray-50 transition-colors';
                const dayNumber = document.createElement('span');
                dayNumber.textContent = day;
                dayNumber.className = 'text-sm self-start';
                const today = new Date();
                if (year === today.getFullYear() && month === today.getMonth() && day === today.getDate()) {
                    dayNumber.className += ' bg-blue-500 text-white rounded-full w-6 h-6 flex items-center justify-center';
                }
                dayCell.appendChild(dayNumber);
                const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                
                if (events[dateString]) {
                    events[dateString].forEach(eventData => {
                        const eventDiv = document.createElement('div');
                        eventDiv.className = 'bg-blue-100 text-blue-800 text-xs rounded px-1 py-0.5 mt-1 cursor-pointer truncate hover:bg-blue-200';
                        eventDiv.textContent = eventData.title;
                        eventDiv.addEventListener('click', (e) => {
                            e.stopPropagation();
                            openEventModal(eventData);
                        });
                        dayCell.appendChild(eventDiv);
                    });
                }
                calendarGrid.appendChild(dayCell);
            }
        };
        
        const fetchGoogleCalendarEvents = (token) => {
            currentAccessToken = token;
            const backendUrl = 'https://calendar-backend-owbu.onrender.com/get-calendar-events';
            fetch(backendUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ accessToken: token }),
            })
            .then(res => res.ok ? res.json() : Promise.reject(res))
            .then(data => {
                calendarEvents = data;
                renderCalendar(calendarEvents);
            })
            .catch(err => console.error('이벤트 로딩 실패:', err));
        };
        
        const createGoogleCalendarEvent = (eventDetails) => {
            if (!currentAccessToken) return alert('로그인이 필요합니다.');
            
            const backendUrl = 'https://calendar-backend-owbu.onrender.com/create-event';
            fetch(backendUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    accessToken: currentAccessToken,
                    ...eventDetails 
                }),
            })
            .then(res => res.ok ? res.json() : Promise.reject(res))
            .then(() => {
                alert('일정이 성공적으로 생성되었습니다!');
                closeNewEventModal();
                fetchGoogleCalendarEvents(currentAccessToken);
            })
            .catch(err => {
                console.error('일정 생성 실패:', err);
                alert('일정 생성에 실패했습니다.');
            });
        };

        // --- 로그인/로그아웃 및 이벤트 핸들러 ---
        onAuthStateChanged(auth, (user) => {
            const isLoggedIn = !!user;
            loginBtn.classList.toggle('hidden', isLoggedIn);
            userProfileDiv.classList.toggle('hidden', !isLoggedIn);
            newEventBtn.classList.toggle('hidden', !isLoggedIn);
            if (user) {
                userProfileDiv.classList.add('flex');
                userNameSpan.textContent = user.displayName;
                userPhotoImg.src = user.photoURL;
            } else {
                currentAccessToken = null;
                renderCalendar({});
            }
        });

        loginBtn.addEventListener('click', () => {
            signInWithPopup(auth, provider)
                .then(result => GoogleAuthProvider.credentialFromResult(result))
                .then(credential => fetchGoogleCalendarEvents(credential.accessToken))
                .catch(err => console.error("로그인 에러:", err));
        });

        logoutBtn.addEventListener('click', () => signOut(auth));

        const openNewEventModal = () => newEventModal.classList.remove('hidden');
        const closeNewEventModal = () => {
            newEventForm.reset();
            newEventModal.classList.add('hidden');
        }

        newEventBtn.addEventListener('click', openNewEventModal);
        cancelNewEventBtn.addEventListener('click', closeNewEventModal);
        
        newEventForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const eventDetails = {
                title: document.getElementById('event-title').value,
                date: document.getElementById('event-date').value,
                description: document.getElementById('event-description').value,
                isPrivate: document.getElementById('event-private').checked
            };
            createGoogleCalendarEvent(eventDetails);
        });

        // --- 초기화 ---
        document.addEventListener('DOMContentLoaded', () => {
            const prevMonthBtn = document.getElementById('prev-month-btn');
            const nextMonthBtn = document.getElementById('next-month-btn');
            const closeModalBtn = document.getElementById('close-modal-btn');

            const closeEventModal = () => eventModal.classList.add('hidden');

            prevMonthBtn.addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() - 1);
                renderCalendar(calendarEvents);
            });

            nextMonthBtn.addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() + 1);
                renderCalendar(calendarEvents);
            });

            closeModalBtn.addEventListener('click', closeEventModal);
            eventModal.addEventListener('click', (e) => {
                if (e.target === eventModal) closeEventModal();
            });
            
            renderCalendar();
        });
    </script>
</body>
</html>
